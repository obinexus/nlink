# ComponentSystem.cmake
# Core component management for NexusLink
#
# This module provides component initialization, registration, and dependency
# management functionality for the NexusLink system.

# Include guard
if(DEFINED NLINK_COMPONENT_SYSTEM_CMAKE_INCLUDED)
  return()
endif()
set(NLINK_COMPONENT_SYSTEM_CMAKE_INCLUDED TRUE)

include(CMakeParseArguments)

# Function to initialize the component system
function(nlink_init_component_system)
  cmake_parse_arguments(
    COMP_INIT
    ""
    "VERSION"
    "COMPONENTS"
    ${ARGN}
  )

  # Validate required arguments
  if(NOT COMP_INIT_COMPONENTS)
    message(WARNING "No components specified for nlink_init_component_system")
  endif()

  # Set default version if not provided
  if(NOT COMP_INIT_VERSION)
    set(COMP_INIT_VERSION "1.0.0")
  endif()

  # Register components
  foreach(COMPONENT ${COMP_INIT_COMPONENTS})
    # Create component directory if it doesn't exist
    nlink_ensure_directory("${NLINK_SRC_DIR}/core/${COMPONENT}")
    nlink_ensure_directory("${NLINK_INCLUDE_DIR}/nlink/core/${COMPONENT}")
    
    # Register component
    nlink_register_component(${COMPONENT} ${COMP_INIT_VERSION})
  endforeach()

  # Define component targets
  add_custom_target(nlink_core_components
    COMMENT "Building all NexusLink core components"
  )

  message(STATUS "Component system initialized with ${COMP_INIT_VERSION}")
  message(STATUS "Registered components: ${COMP_INIT_COMPONENTS}")
endfunction()

# Function to register a component
function(nlink_register_component COMPONENT)
  # Parse additional arguments
  cmake_parse_arguments(
    COMP_REG
    "REQUIRED;OPTIONAL"
    "VERSION;DESCRIPTION;AUTHOR"
    "DEPENDENCIES;SOURCES;INCLUDES"
    ${ARGN}
  )

  # Provide default values for optional parameters
  if(NOT COMP_REG_VERSION)
    set(COMP_REG_VERSION "1.0.0")
  endif()

  # Register component in global property
  set_property(GLOBAL APPEND PROPERTY NLINK_REGISTERED_COMPONENTS ${COMPONENT})
  set_property(GLOBAL PROPERTY NLINK_COMPONENT_${COMPONENT}_VERSION ${COMP_REG_VERSION})
  
  message(STATUS "Registered component: ${COMPONENT} (version ${COMP_REG_VERSION})")
endfunction()

# Function to get component dependencies
function(nlink_get_component_dependencies COMPONENT OUTPUT_VAR)
  # Implementation to be added based on dependency specifications
  set(${OUTPUT_VAR} "" PARENT_SCOPE)
endfunction()

# Function to build a component with enhanced parameter handling
function(nlink_build_component)
  # Extract component name for unique binary directory formation
  cmake_parse_arguments(
    BUILD_COMP
    "SHARED;STATIC;MODULE;VERBOSE"
    "COMPONENT;NAME;OUTPUT_NAME;VERSION;TYPE"
    "SOURCES;HEADERS;INCLUDES;DEPENDENCIES;COMPILE_DEFINITIONS;COMPILE_OPTIONS"
    ${ARGN}
  )

  # Determine component identifier with fallback
  if(BUILD_COMP_COMPONENT)
    set(COMPONENT_ID ${BUILD_COMP_COMPONENT})
  elseif(BUILD_COMP_NAME)
    set(COMPONENT_ID ${BUILD_COMP_NAME})
  else()
    get_filename_component(COMPONENT_ID ${CMAKE_CURRENT_SOURCE_DIR} NAME)
  endif()
  
  # Configure unique binary directory path to prevent collisions
  set(UNIQUE_BINARY_DIR "${CMAKE_CURRENT_BINARY_DIR}/${COMPONENT_ID}_build")
  
  # Log configuration for debugging
  if(BUILD_COMP_VERBOSE)
    message(STATUS "Component ${COMPONENT_ID}: Using binary directory ${UNIQUE_BINARY_DIR}")
  endif()

  # Validate required arguments
  if(NOT BUILD_COMP_COMPONENT)
    message(FATAL_ERROR "COMPONENT parameter is required for nlink_build_component")
  endif()

  # Set default library type if not specified
  set(LIB_TYPE "STATIC")
  if(BUILD_COMP_SHARED)
    set(LIB_TYPE "SHARED")
  elseif(BUILD_COMP_MODULE)
    set(LIB_TYPE "MODULE")
  endif()

  # Define component names
  set(COMPONENT_NAME ${BUILD_COMP_COMPONENT})
  set(COMPONENT_TARGET nlink_component_${COMPONENT_NAME})
  
  # Set output name if provided
  if(BUILD_COMP_OUTPUT_NAME)
    set(OUTPUT_NAME ${BUILD_COMP_OUTPUT_NAME})
  else()
    set(OUTPUT_NAME "nlink_${COMPONENT_NAME}")
  endif()

  # Set default sources if not provided
  if(NOT BUILD_COMP_SOURCES)
    file(GLOB BUILD_COMP_SOURCES 
      "${CMAKE_CURRENT_SOURCE_DIR}/*.c"
      "${CMAKE_CURRENT_SOURCE_DIR}/*.cpp"
    )
  endif()

  # Build the component library
  add_library(${COMPONENT_TARGET} ${LIB_TYPE} ${BUILD_COMP_SOURCES})
  set_target_properties(${COMPONENT_TARGET} PROPERTIES
    OUTPUT_NAME ${OUTPUT_NAME}
    VERSION ${BUILD_COMP_VERSION}
  )

  # Add include directories
  target_include_directories(${COMPONENT_TARGET} PUBLIC
    ${NLINK_INCLUDE_DIR}
    ${BUILD_COMP_INCLUDES}
  )

  # Add compile definitions
  if(BUILD_COMP_COMPILE_DEFINITIONS)
    target_compile_definitions(${COMPONENT_TARGET} PRIVATE
      ${BUILD_COMP_COMPILE_DEFINITIONS}
    )
  endif()

  # Add compile options
  if(BUILD_COMP_COMPILE_OPTIONS)
    target_compile_options(${COMPONENT_TARGET} PRIVATE
      ${BUILD_COMP_COMPILE_OPTIONS}
    )
  endif()

  # Link dependencies
  if(BUILD_COMP_DEPENDENCIES)
    target_link_libraries(${COMPONENT_TARGET} PRIVATE
      ${BUILD_COMP_DEPENDENCIES}
    )
  endif()

  # Add to components target
  add_dependencies(nlink_core_components ${COMPONENT_TARGET})
  
  message(STATUS "Built component: ${COMPONENT_NAME} (${LIB_TYPE})")
endfunction()
